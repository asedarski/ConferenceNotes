# Building Interactivity with WebSockets
## Wim Godden - @wimgtr - Founder of [Cu.be Solutions](http://cu.be)
Developer of PHPCompatability
- Old: Show content, wait for the user to click link or button
    - Basically a refresh... :-(
- New: Show content + send user real-time updates
- Real-time = key to keep users on your platform
- First real-time implementation: AJAX polling
    - Potentially puts a lot of load on the server
    - Short polling: get -> status 0 -> get -> status 0 -> get -> status 1 -> get... and so on
    - Long polling: get -> server waits to respond until there is data then sends status 1
    - SSE (Server Sent Events): get -> server waits to respond until there is data and then the connection
      stays open and server continues to send the data
        - Works for one way data transfers
    - The process of TCP connections is slow (even more so with SSL)
- WebSockets
    - Initiate and upgrade connection -> data transfer back and forth
    - Handshake
        - Sends a GET request with headers
            - Upgrade: websocket
            - Connection: upgrade
            - Origin: http://yourhost.com
            - Sec-Websocket-Key: _string_
            - Sec-Websocket-Protocol: chat (server and client can use different protocol)
            - Sec-Websocket-Version: 13
        - Server response
            - HTTP/1.1 101 Switching Protocols
            - Upgrade: websocket
            - Connection: upgrade
            - Sec-Websocket-Accept: origin key with some changes (didn't quite catch that)
            - Sec-Websocket-Protocol: chat
    - Protocols
        - Must be supported by client and server
        - Several exist
            - WAMP (provides PubSub)
            - STOMP (provides messaging)
        - Can be application specific (custom)
    - Events
        - Open
        - Close
        - Message
        - Error
    - Methods
        - send()
        - close()
    - Uses
        - Synchronize data between users
        - Multiplayer HTML5 games
        - Live feeds
        - Auctions
        - Real-time updates on running processes
        - Financial applications
        - Messaging / chat
    - Advantages
        - Full-duplex messaging
        - 100% asynchronus
        - HTTP overhead only on initial handshake
        - Low latency
        - Low bandwidth
        - Messages can be fragmented
            - Sent partially (when message is not complete yet)
            - Sent in-between other messages
            - Ex. sending an image in chat can be broken up into chunks
    - Disadvantages
        - No caching (unlike XHR/HTTP)
        - Some application changes required
        - No message acknowledgement built-in
        - Ping-pong (present in RFC) not in most browsers
            - Write your own
            - Use socket.io
    - Server side code is run once which can support 1-1000s of client websockets
    - Using PubSub
        - Publish/Subscribe
        - Central message broker
        - Clients publish messages or subscribe
        - Examples:
            - ZeroMQ
            - Redis
        - PubSub to clients
            - Directly in the browser: bad idea, gives client too much control
            - Defined in PHP, only exposed via the websocket layer
    - Security
        - Always use TLS (wss:// instead of ws://)
        - Verify the Origin header - but don't think this secures you
        - Pass along a random token to the handshake request
            - Don't forget: session cookies in HTTP are not automatically sessions in WebSocket
    - HTTP
        - It's what we use every day
        - HTTP/2
            - Developed by Google as SPDY
            - Designed for speed
            - Multiple simultaneous requests/responses in one connection
            - Binary format (pro: more efficient, con: harder to debug)
            - TLS/SSL encryption is standard
            - Built-in prioritization
            - Server push
                - Not a replacement for websocket since it doesn't allow for true two way communication
            - Header compression
            - No websocket support
    - Tips and Tricks
        - If you proxy WebSocket traffic through nginx
            - Increase proxy read and send timeouts
        - HAProxy
            - Increase timeout
        - [Interesting Read](https://hpbn.co/websocket/)
        - Beware: if your websocket server crashes, you lose all your clients and status
    - PHP Websocket server libraries
        - Ratchet
        - Woketo (client + server, PHP7 only)
        - phpws
    - Useful tools
        - websocket.org
        - Chrome developer console
        - Firefox add-on: WebSockets Monitor
        - [Thor (benchmark)](https://github.com/observing/thor)
        - [Websocket-bench](https://github.com/M6Web/websocket-bench)
        - Socket.io for backwards compatibility
    - ![Client Code](https://lh3.googleusercontent.com/TfhfRYZKxBx0zrvgCV9XUEYVr84Q46w7IYPOhIbxPgdt3AGFtZBCW4XVpnbCOBF-fEXrbxgsXGu5x2V1cve4P90HnNWjCz92T7zAH8JO7TrEPHVLadjHuNwEsKV5D6Q3yCRG_ZMY80frDXHj2BG7aPCDxlb-XZk9vsGrznNXQrFpkXbnTzOY7fsLyf5L_m_kI9bvEASTbDRbJFluuyGVyavaLKg_cIHEN_FaMYydCBAS_hQA2F5NHTm_4NHG9XN-iAd6RDA_yRmXJQ2WL23MbTCH_winAuclkonBpBBNKVLTyvCrKbftLST4k37Qe7b_YOd-_zu7TQiF13tDB7rRUXWmGJq9Esay--DpVRu6xSo2N7IqY_OppgE8hDpfgPPJ3y0bjabVsxDLozyx0VH__blbUPjYLBtYCz3be1bFWMUDOO0m_ocIjs-rDQneynQZfn1TGGNkrYVBvHGAEATX7WetnXjW-LGcGr2WganIHTmSaRNEEFKi1wT4ODFfx34J2t21ifYOQh860iIiIn32KQrY0CG0JREpxCUdeeH1N9ru4-mA-F4tV5zzl0sVcIhC5HbslVsaVDPPg2i6s_h_ASpPQRytSf9j_DN97fx3wow=w725-h966-no)
    - ![Server Code](https://lh3.googleusercontent.com/IeKi3_Dr4kb22X0VaUqKevFNlijuRAwdZPYCt3WqEHOEJpoD-7YLxs4SJdi3wQXHaE4iqYyL-hyHoDdy6K3GLXjWxZsL6KS0uQx0t5VZ8VghrORbMk6yDY27l03bB8Vei6NxMxrhB08CnPS2HYp9wfcXOL4sfDGocTtHi10idGpKlWZbg1G0fjetwQ5i7SqMN9gefnLzkbI2UBEpQXzaRmGOl5847pHGcWCybK9_IEsaXv5xjGyi29vKH59-6pQcrRWvyeCIXMFN1qJEm5BQ8_6qwbsAhU6HWuHbUTARgG2nAfoY8NSUF1VmLBmBLUITrLN53-aNEJQdtxTDL5P-tj1l2D94ew0BQyq1jtkFvuAMgaGgMulZHemaQuvGAxuPfJW0i22jILrJJ4yAjge5yoSxdnsz3h5SzbfFpXrDR5d0dUQm-Hfl4Uf3gcRdsqUh87Q67r2j_w08rGAwIce9LGY6vYlw-TE4yjUwNFNPnTKkRxAmMxaOaHeHEo0QKDXEuyPxynOnSE0ktUN579xct8uppV-5-eaj2YEpihoQgXu0Oh5BRGVor3f_XNXBX7PfAJ8zf1WwmZQwe_ev-CNv3Uo3EeHr0GJzyL9wO0EflqE=w725-h966-no)
    - ![Adding Clients](https://lh3.googleusercontent.com/sKep7DXlewuSIFrr9a4RajiMnHui7iYs349WA20xh9wpLzwMB_He-QX_WejaaccsFtxICM1aZBESWoWAfmbNB9MpUyK-HruLfXx8zlHK7OmOperA52bVl7fbLQCAJorgV4MH4byI5Ldr29TvLdvwgXiH3mEFRM-HoWiS6QDxPXoLGk7Rx6hcCV3T51R7p7YI0BQkuXcb2lHk1CQeMSn5SsCeoVuyZCam2CzchdBbstbQU3sw1FJfg_QMbtjLyWr_sxG47c4-0UfuCZqQ9awZSiQxZCmboDeeJTG3qhzcsKGZZVNXDu3NKsKTIZQvWkj3IKzJNpt_jbpeoWS6Y0LRm90eMLmcvPdFM_T3tL9GwJtpOHqUD7vEzIX9kjV6tIvJ5D1jcA2FRuJqDWWRhuHCydp0eAvq70iONT11E9jyObY4zasfSq2l6cszG6vr97Tm9OInAx__blgMOPKuOGdWasW8SIkB_Zn5jnbF52YGgsUVDZRSrL6kRL2aI71C776GbcgC5MyIS_3dSzlNstnt2qv1o1Cn8wZXvmRoB1ayLg9Q4ur3Zmr1Smna0Rj2FlezbLKncLn8AttjlZPLRMKLLKDfKljfmNm9IcwDUyLJgpc=w725-h966-no)
    - ![Dealing With Data](https://lh3.googleusercontent.com/hn_b-m0vqHwIVbg77h05QRHbjab3F_VneiRcAnhb1Qu2Eqvj7GInd23r07rckMsKqBIZheBGxUQUK2RV0R1Mxy-1_URSaBv4GzIwuB-aVdehtsL4hlkmAFG1EktTjJJpwS5NjouSCX7nmVw8XolmDECXzcxttFvYvSqwmzubmcQ3VP1wBZHd1SWq_Vc4N6WvcGMYOxThOAj_NYNf-ea3Cv0K20L3JvZptY1Y5GupwbL8nxHKJPNg42jt-4p0Skk_2LkSoa12dyiknogt8G5oEx7zRMcg09PZdi75c4mPQlrYJgkV0io1clYo763n8597nr6ftBW8lebRc3d95uKxYReGk7U-bycaPJZre5eVCtm93OnjMCOJou_IgKXNfA6WYS8iSRRLmF41uBWAUGf4pt-8U8i4ei_c12QmW9hjs5WefW_wiJw9qREn0nxlZdIH7eXENmi0xOML0n2piMpLgzT7art5cpKXmzu0Dyxaa1lRRWosiaa1YXrpD4eOfWAZ4kJbBy4OebUDNBwqlaqfnpe4dt41pWQDa7bk1jdjcO4dgUwl3vQKN2rZ3NWEmcbrxquE48dF9_lBrk9Ga89mLoHYRXeAlkUskXNHhvVyTzY=w725-h966-no)
